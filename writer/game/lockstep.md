
----------
#### 同步要点

 1. 逻辑部分去float，可以使用分数表示，记录一对分子分母（定点数?）
 3. 没有HostPlayer
 4. 一致的随机数种子
 5. 遍历的顺序：
	 1. Hashtable --> SortedDictionary
	 2. Raycast返回的结果：物品带唯一id，排序后使用第一个
	 3. Lua Table ：Pairs --> iPairs
 6. **数据层**避免受**逻辑层**反向影响：比如某些客户端资源加载未完成导致代码流程不一定的情况
 7. 虽然数据层不能裁剪，但是在逻辑层却是可以的
 8. 各client的update频率必须一致
 9. 数据层只能使用数据层的数据，不能使用其它的本地数据（不能引入其它任何的命名空间）：
	 1. 摄像机、子弹的位置
	 2. 人是否可见
 10.  注意未初始化的成员变量（出错时是很难意识到的），特别是如果使用了其它库的话（尽量不要用）
 11. Transform的更新顺序：比如Camera, Player, HUD的更新顺序如果有问题，会导致看起来HUD抖动

----------
#### 网络要点

数据层与逻辑层分离，数据层完全与服务器同步一致，逻辑层自己做插值平滑；逻辑帧并不等待客户端的command的，没有服务器数据的话就假定使用上一帧的数据（特别是移动相关的）

1. 无buffer帧同步，数据层0延迟
2. 不使用P2P
3. 使用UDP
	1. 加快发送频率，多发，做冗余，做窗口排序
	2. UDP连不上的时候还要退回到TCP
	3. 《TCP/IP详解》
4. 网络延迟：是不是可以自己在编辑器里设置（比如400ms），为了调试方便
5. 网络流量 = 指令个数 x 同步频率
6. 断线重连（中途加入） = 快照 + 增量

##### 帧同步buffer机制

帧buffer 	| 延迟		| 卡顿
---			|--- 		|---
帧buffer小	| 延迟低	| 卡顿多
帧buffer大  | 延迟高	| 卡顿少


----------
#### 状态同步 VS. 帧同步

针对帧同步的一些缺点，需要注意设计时规避

Topic 		| 状态同步	| 帧同步
---			|--- 				|---
反外挂		| 服务器说了算				| 很容易修改client数据（王者荣耀：单局，弱成长线）
网络带宽、抖动	|适应能力强，300ms延迟无所谓 |  网络命令的延迟会引起挤压、卡顿
断线重连	| 状态同步即可，比较快	| 断线重回的时间**非常非常长**
网络流量 | 一场PVP，可能几十M	| 基本上是稳定的，观战、录像
客户端性能优化 | 视窗裁剪，看不见的地方不计算 | 不适合同场景几百上千人的大型游戏
开发效率 | 有时很难做到跟服务器状态一致	| 开发思路跟单机类似
强体格斗游戏 | 做精确同步数据量会非常大 | 动作本身的密度可以做到很高的频率
离线战斗 | 额外开发 | 原生支持
example	| Dota2, LOL, 守望先锋	| DOTA(Warcraft3)，风暴英雄(StarCraft2)，王者荣耀


----------
#### C# VS. C++

Topic 	| C# 	| C++
---		|--- 	|---
debug	| 可以用断点 | 需要先编译成.a文件
speed	| slow	| fast，2.5倍差距，2~3帧的提升
anti-cheat	| 裸奔 | 安全
online-update | can | can't
GC		| 有	| 无


Topic 		| 序列化 	| 内存快照
---			|--- 		|---
speed		| slow   	| fast
version	    | possible	| impossible
存盘		| 是		| 否
coding	  	| 无限制	| struct，不能使用虚函数
版本维护	| 考虑兼容	| 只支持当前版本


----------
#### 反外挂

> 要不要跑两种验证机制：1v1时跑server验证，2v2时投票；要不要分成大验证与小验证

Cheat 		| Anti-Cheat
---			|---
修改属性	| 只改本地数据，别的client还是正确的；属性算个hash传给server验证（或投票）；加密
透视			| 开图挂，对于一些关键的点数据（如开图的bool变量）上传验证
自动操作	| 自动瞄准对FPS游戏影响大，发动玩家举报
皮肤美化 | ......


----------
#### 王者荣耀

1. RTS --> 减少英雄数 --> 5到3个，变得更像MOBA
2. Demo （含引擎、框架、后台）2周就做完了，6个月做完第一个版本，2015-08-18上线
3. 不同步率，由最初的1%到现在的万分之几（资源加载失败导致的状态不一致）
4. client与server同步帧率为15fps，自己逻辑帧率为30fps
5. 性能优化：
	1. 战斗时不使用反射，加载时可以
	2. 把对象的显示隐藏放到不同的渲染层里面去
	3. 王者的gc平均每帧在1K左右，很难做到200
	2. 3DUI，
	2. Loading时加载了所有东西，所以加载时间长
6. 单CPU满（发热、降频），其中逻辑消耗占20%左右，但GPU只吃到了30%
7. 服务器的主频其实不高

----------
#### 其它问题
1. behaviac插件对AI设计的影响
2. 寻路，服务器bake vs. 路点，服务器开销，随机地图
3. 中途加入

----------
#### Reference
1. [《王者荣耀》技术总监复盘回炉历程：没跨过这三座大山，就是另一款MOBA霸占市场了](http://youxiputao.com/articles/11842)
2. [【王者荣耀】透视+无CD+无敌外挂分析](http://gslab.qq.com/article-260-1.html)
3. [游戏中的网络同步机制——Lockstep](http://bindog.github.io/blog/2015/03/10/synchronization-in-multiplayer-networked-game-lockstep/?utm_source=tuicool&utm_medium=referral)
4. [《守望先锋》技术分享视频：如何处理网络同步与减少网络迟疑](http://mp.weixin.qq.com/s?__biz=MjM5NTMxNTU0MQ==&mid=2649869814&idx=1&sn=c8da90fbfe553d9a434288d81f972a87&scene=2&srcid=07056E5ckMN3MZDBmRy33qoA&from=timeline&isappinstalled=0#wechat_redirect)
5. [网络游戏的移动同步（五）帧同步算法](http://www.zhust.com/index.php/2015/08/%E7%BD%91%E7%BB%9C%E6%B8%B8%E6%88%8F%E7%9A%84%E7%A7%BB%E5%8A%A8%E5%90%8C%E6%AD%A5%EF%BC%88%E4%BA%94%EF%BC%89%E5%B8%A7%E5%90%8C%E6%AD%A5%E7%AE%97%E6%B3%95/)


